name: SPFx PipelineSolution2

on:
  push:
    branches:
      - ayush
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ðŸ§© Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # ðŸ§© Step 2: Setup Node.js (v20 LTS)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ðŸ§© Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # ðŸ§© Step 4: Install Microsoft 365 CLI
      - name: Install Microsoft 365 CLI
        run: npm install -g @pnp/cli-microsoft365

      # ðŸ§© Step 5: Build and package SPFx solution
      - name: Build and package SPFx solution
        run: |
          gulp clean
          gulp bundle --ship
          gulp package-solution --ship

      # ðŸ§© Step 6: Deploy SPFx package to SharePoint
      - name: Deploy to SharePoint
        shell: pwsh
        run: |
          $siteUrl = "${{ secrets.SPO_SITE_URL }}"
          $username = "${{ secrets.SPO_USERNAME }}"
          $password = ConvertTo-SecureString "${{ secrets.SPO_PASSWORD }}" -AsPlainText -Force
          $creds = New-Object System.Management.Automation.PSCredential ($username, $password)
          Connect-PnPOnline -Url $siteUrl -Credentials $creds
          Add-PnPApp -Path "sharepoint/solution/hhhh-portal.sppkg" -Publish

          Write-Host "ðŸ“¦ Uploading SPFx package to App Catalog..."
          m365 spo app add `
            --filePath "./sharepoint/solution/share-point-test.sppkg" `
            --appCatalogUrl "https://hhhhteams.sharepoint.com/sites/appcatalog" `
            --overwrite

          Write-Host "ðŸš€ Deploying SPFx package..."
          m365 spo app deploy `
            --name "share-point-test.sppkg" `
            --appCatalogUrl "https://hhhhteams.sharepoint.com/sites/appcatalog" `
            --skipFeatureDeployment

          Write-Host "âœ… Deployment completed successfully!"
          m365 logout
