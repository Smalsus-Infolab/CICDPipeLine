name: SPFx PipelineSolution2

on:
  push:
    branches:
      - ayush
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout ayush branch
        uses: actions/checkout@v4
        with:
          ref: ayush

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Install Gulp
        run: npm install gulp-cli -g

      - name: Install Microsoft 365 CLI
        run: npm install -g @pnp/cli-microsoft365

      - name: Build and package SPFx solution
        run: |
          gulp clean
          gulp bundle --ship
          gulp package-solution --ship

      - name: Debug file existence
        run: |
          echo "Checking if .sppkg file exists..."
          dir sharepoint/solution

      - name: Deploy to SharePoint
        shell: pwsh
        run: |
          echo "üîê Logging into Microsoft 365..."
          m365 login --authType certificate `
            --appId "7a4c0ac6-0f6a-4111-b80d-4ae60dc4ff5c" `
            --tenant "249283bb-0d3b-4521-8dc1-e1aff7743266" `
            --certificateBase64Encoded "${{ secrets.M365_CERT_BASE64 }}" `
            --password "StrongPass@123"

          echo "üîé Checking app catalog site..."
          m365 spo site get --url "https://smalsusinfolabs.sharepoint.com/sites/apps/appcatalog"

          echo "üì¶ Uploading SPFx package to App Catalog...."
          m365 spo app add `
            --filePath "sharepoint/solution/share-point-test.sppkg" `
            --appCatalogUrl "https://smalsusinfolabs.sharepoint.com/sites/apps/AppCatalog" `
            --overwrite

          echo "üöÄ Deploying SPFx package..."
          m365 spo app deploy `
            --name "share-point-test.sppkg" `
            --appCatalogUrl "https://smalsusinfolabs.sharepoint.com/sites/apps/AppCatalog" `
            --skipFeatureDeployment

          echo "‚úÖ Deployment completed successfully!"
          m365 logout
