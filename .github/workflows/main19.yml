name: SPFx PipelineSolution1

on:
  push:
    branches:
      - CIPipeLineBranch
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: windows-latest

    steps:
      # üß© Step 1: Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # üß© Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # üß© Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci --force

      # üß© Step 4: Build and package SPFx
      - name: Build & Package SPFx Solution
        shell: pwsh
        run: |
          Write-Host "üßπ Cleaning and building SPFx..."
          $env:NODE_OPTIONS="--max_old_space_size=8192"
          npx gulp clean
          npx gulp build
          npx gulp bundle --ship
          npx gulp package-solution --ship

      # üß© Step 5: Verify GitHub secrets
      - name: üîç Verify Secrets
        shell: pwsh
        env:
          M365_APP_ID: ${{ secrets.M365_APP_ID }}
          M365_TENANT_ID: ${{ secrets.M365_TENANT_ID }}
          M365_CERTIFICATE_BASE64: ${{ secrets.M365_CERTIFICATE_BASE64 }}
          M365_CERTIFICATE_PASSWORD: ${{ secrets.M365_CERTIFICATE_PASSWORD }}
        run: |
          $required = @('M365_APP_ID','M365_TENANT_ID','M365_CERTIFICATE_BASE64','M365_CERTIFICATE_PASSWORD')
          foreach ($s in $required) {
            if (-not (Test-Path "Env:\$s")) { Write-Error "‚ùå Secret $s missing!"; exit 1 }
            else { Write-Host "‚úÖ Secret $s found." }
          }

      # üß© Step 6: Deploy SPFx App
      - name: üöÄ Deploy SPFx App to Tenant Catalog
        shell: pwsh
        env:
          M365_APP_ID: ${{ secrets.M365_APP_ID }}
          M365_TENANT_ID: ${{ secrets.M365_TENANT_ID }}
          M365_CERTIFICATE_BASE64: ${{ secrets.M365_CERTIFICATE_BASE64 }}
          M365_CERTIFICATE_PASSWORD: ${{ secrets.M365_CERTIFICATE_PASSWORD }}
        run: |
          Write-Host "üì¶ Installing Microsoft 365 CLI..."
          npm install -g @pnp/cli-microsoft365@latest

          Write-Host "üîê Preparing certificate..."
          $certPath = "C:\\cert.pfx"
          [IO.File]::WriteAllBytes($certPath, [Convert]::FromBase64String($Env:M365_CERTIFICATE_BASE64))
          
          if (-Not (Test-Path $certPath)) {
            Write-Error "‚ùå Certificate creation failed!"
            exit 1
          }

          Write-Host "üîë Logging into Microsoft 365..."
          m365 login --authType certificate `
            --appId $Env:M365_APP_ID `
            --tenant $Env:M365_TENANT_ID `
            --certificateFile $certPath `
            --password $Env:M365_CERTIFICATE_PASSWORD

          $tenantAdminUrl = "https://$($Env:M365_TENANT_ID)-admin.sharepoint.com"
          Write-Host "üåê Connecting to $tenantAdminUrl ..."
          m365 spo connect --url $tenantAdminUrl

          Write-Host "üìÅ Searching for .sppkg package..."
          $pkg = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter *.sppkg | Select-Object -First 1

          if (-not $pkg) {
            Write-Error "‚ùå No .sppkg file found!"
            exit 1
          }

          Write-Host "üì§ Uploading and deploying SPFx app..."
          try {
            m365 spo app add --filePath "$($pkg.FullName)" --appCatalogScope tenant --overwrite
            m365 spo app deploy --name (Split-Path $pkg.FullName -Leaf) --appCatalogScope tenant --skipFeatureDeployment
            Write-Host "‚úÖ SPFx App deployed successfully!"
          }
          catch {
            Write-Error "‚ùå Deployment failed: $($_.Exception.Message)"
            exit 1
          }
