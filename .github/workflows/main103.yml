name: SPFx PipelineSolution1

on:
  push:
    branches:
      - CIPipeLineBranch
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      # üß© Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # üß© Step 2: Setup Node.js (v18 LTS)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # üß© Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # üß© Step 4: Install PnP Microsoft 365 CLI
      - name: Install Microsoft 365 CLI
        run: npm install -g @pnp/cli-microsoft365

      # üß© Step 5: Build and package SPFx solution
      - name: Build and package SPFx solution
        run: |
          gulp clean
          gulp bundle --ship
          gulp package-solution --ship

      # üß© Step 6: Deploy to SharePoint
      - name: Deploy to SharePoint
        env:
          SP_USERNAME: ${{ secrets.SP_USERNAME }}
          SP_PASSWORD: ${{ secrets.SP_PASSWORD }}
        run: |
          echo "üîê Logging in to Microsoft 365..."
          m365 login --authType password --userName "$env:SP_USERNAME" --password "$env:SP_PASSWORD" --tenant "https://hhhhteams.sharepoint.com"
          echo "üì¶ Uploading SPFx package..."
          m365 spo app add --filePath "./sharepoint/solution/share-point-test.sppkg" --appCatalogUrl "https://hhhhteams.sharepoint.com/sites/appcatalog/AppCatalog" --overwrite
          echo "üöÄ Deploying SPFx package..."
          m365 spo app deploy --name "share-point-test.sppkg" --appCatalogUrl "https://hhhhteams.sharepoint.com/sites/appcatalog/AppCatalog" --skipFeatureDeployment
          m365 logout
