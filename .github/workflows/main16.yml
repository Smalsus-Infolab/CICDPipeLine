name: SPFx PipelineSolution1

on:
  push:
    branches:
      - CIPipeLineBranch
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: windows-latest

    steps:
      # üß© Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # üß© Step 2: Setup Node.js (v20)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # üß© Step 3: Install Dependencies
      - name: Install Dependencies
        run: npm ci --force

      # üß© Step 4: Build & Package SPFx Solution
      - name: Build & Package SPFx Solution
        shell: pwsh
        run: |
          Write-Host "üßπ Cleaning and building SPFx..."
          $env:NODE_OPTIONS="--max_old_space_size=8192"
          npx gulp clean
          npx gulp build
          npx gulp bundle --ship
          npx gulp package-solution --ship

      # üß© Step 5: Verify Secrets (Check all GitHub Secrets)
      - name: üîç Verify Secrets Access
        shell: pwsh
        run: |
          if ("${{ secrets.M365_APP_ID }}" -eq "") { Write-Error "‚ùå M365_APP_ID not accessible" } else { Write-Host "‚úÖ M365_APP_ID accessible" }
          if ("${{ secrets.M365_TENANT_ID }}" -eq "") { Write-Error "‚ùå M365_TENANT_ID not accessible" } else { Write-Host "‚úÖ M365_TENANT_ID accessible" }
          if ("${{ secrets.M365_CERTIFICATE_BASE64 }}" -eq "") { Write-Error "‚ùå M365_CERTIFICATE_BASE64 not accessible" } else { Write-Host "‚úÖ M365_CERTIFICATE_BASE64 accessible" }
          if ("${{ secrets.M365_CERTIFICATE_PASSWORD }}" -eq "") { Write-Error "‚ùå M365_CERTIFICATE_PASSWORD not accessible" } else { Write-Host "‚úÖ M365_CERTIFICATE_PASSWORD accessible" }

      # üß© Step 6: Deploy SPFx App to Tenant App Catalog (using PnP CLI)
      - name: Deploy SPFx App to Tenant Catalog (Certificate Auth)
        shell: pwsh
        run: |
          Write-Host "üì¶ Installing Microsoft 365 CLI..."
          npm install -g @pnp/cli-microsoft365@latest

          Write-Host "üîê Preparing certificate..."
          $certPath = "C:\\cert.pfx"
          [System.IO.File]::WriteAllBytes($certPath, [System.Convert]::FromBase64String("${{ secrets.M365_CERTIFICATE_BASE64 }}"))

          if (-Not (Test-Path $certPath)) {
            Write-Error "‚ùå Failed to create certificate file."
            exit 1
          }

          Write-Host "üîë Logging into Microsoft 365 with certificate..."
          try {
            m365 login --authType certificate `
              --appId "${{ secrets.M365_APP_ID }}" `
              --tenant "${{ secrets.M365_TENANT_ID }}" `
              --certificateFile $certPath `
              --password "${{ secrets.M365_CERTIFICATE_PASSWORD }}"
          } catch {
            Write-Error "‚ùå Microsoft 365 login failed. Check certificate or password."
            exit 1
          }

          Write-Host "üìÅ Searching for SPFx package..."
          $pkg = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -Filter *.sppkg | Select-Object -First 1

          if (-not $pkg) {
            Write-Error "‚ùå No .sppkg file found!"
            exit 1
          }

          Write-Host "üì§ Uploading and deploying SPFx app..."
          m365 spo app add --filePath $pkg.FullName --appCatalogScope tenant --overwrite
          m365 spo app deploy --name (Split-Path $pkg.FullName -Leaf) --appCatalogScope tenant --skipFeatureDeployment

          Write-Host "‚úÖ SPFx App deployment completed successfully!"
